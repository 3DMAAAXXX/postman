name: Postman-Teston

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-api:
    name: Test ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [products, orders, users]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          
      - name: Install newman
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra
          
      - name: Install dependencies
        run: npm install
        
      - name: Start mock API
        run: |
          cp mockApi/db_back_up.yaml mockApi/db_stage.yaml
          npx yaml-server --hotReload=off --autoStart=off --port 3000 --database ./mockApi/db_stage.yaml &
          
      - name: Make directory for results
        run: mkdir -p testResults
        
      - name: run Postman collection
        run: |
          newman run NewStore.postman_collection.json \
          -e environments/${{ matrix.environment }}.json \
          -r htmlextra \
          --reporter-htmlextra-export testResults/report.html \
          --reporter-htmlextra-title "Report for ${{ matrix.environment }}" \
          --reporter-htmlextra-darkTheme
          
      # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–∂–µ–Ω –∑–≤—ñ—Ç –∑ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º —ñ–º'—è–º –ø–∞–ø–∫–∏
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.environment }} # –Ü–º'—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É = –Ω–∞–∑–≤–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
          path: testResults/report.html

  generate-combined-report:
    needs: test-api
    if: always() # –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ç–µ—Å—Ç–∏ –≤–ø–∞–ª–∏
    runs-on: ubuntu-latest
    steps:
      - name: Create Public Folder
        run: mkdir -p public

      # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –í–°–Ü –∑–≤—ñ—Ç–∏ –≤ –ø–∞–ø–∫—É public
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: public

      # –¶–µ–π –∫—Ä–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î –æ–¥–∏–Ω —Ñ–∞–π–ª –º–µ–Ω—é (index.html)
      - name: Generate Dashboard
        run: |
          echo "<!DOCTYPE html>
          <html>
          <head>
            <title>Test Run Dashboard</title>
            <style>
              body { font-family: sans-serif; background: #222; color: #fff; text-align: center; padding: 50px; }
              h1 { margin-bottom: 40px; }
              .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
              .card { background: #333; padding: 20px; border-radius: 8px; width: 200px; text-decoration: none; color: white; transition: 0.3s; border: 1px solid #444; }
              .card:hover { background: #444; transform: translateY(-5px); }
              .status { font-size: 0.8em; color: #aaa; margin-top: 10px; display: block; }
            </style>
          </head>
          <body>
            <h1>üöÄ API Test Automation Results</h1>
            <div class='container'>
              <a href='products/report.html' class='card'>üì¶ <strong>Products</strong><span class='status'>Click to view report</span></a>
              <a href='orders/report.html' class='card'>üõí <strong>Orders</strong><span class='status'>Click to view report</span></a>
              <a href='users/report.html' class='card'>üë§ <strong>Users</strong><span class='status'>Click to view report</span></a>
            </div>
            <p style='margin-top:50px; color: #666'>Generated by GitHub Actions</p>
          </body>
          </html>" > public/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
