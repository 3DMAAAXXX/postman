name: Postman-Teston

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-api:
    name: Test ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [products, orders, users]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          
      - name: Install newman
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra
          
      - name: Install dependencies
        run: npm install
        
      - name: Start mock API
        run: |
          cp mockApi/db_back_up.yaml mockApi/db_stage.yaml
          npx yaml-server --hotReload=off --autoStart=off --port 3000 --database ./mockApi/db_stage.yaml &
          
      - name: Make directory for results
        run: mkdir -p testResults
        
      - name: run Postman collection
        run: |
          newman run NewStore.postman_collection.json \
          -e environments/${{ matrix.environment }}.json \
          -r htmlextra \
          --reporter-htmlextra-export testResults/index.html \
          --reporter-htmlextra-darkTheme
          
      # Ми називаємо артефакт "report-<назва>", щоб потім створилась така папка
      - name: Output the run Details
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.environment }}
          path: testResults/index.html

  deploy-reports:
    needs: test-api
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Створюємо папку для публікації
      - name: Create Public Folder
        run: mkdir -p public

      # Завантажуємо всі артефакти. 
      # В папці public з'являться підпапки: report-products, report-orders, report-users
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: public

      # Публікуємо папку public як є
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
